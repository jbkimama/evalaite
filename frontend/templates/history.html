{% extends "base.html" %}

{% block title %}History - Evalaite{% endblock %}

{% block content %}
<div class="container">
    <div class="history-header">
        <h1>Evaluation History</h1>
        <button type="button" class="btn btn-secondary" id="export-all-btn">Export All as CSV</button>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <div id="history-content" class="hidden">
        <div id="summary-stats" class="summary-card" style="margin-bottom: 1.5rem;">
            <div class="summary-item">
                <span class="label">Total Evaluations</span>
                <span id="total-evals" class="score">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Completed</span>
                <span id="completed-evals" class="score score-good">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Failed</span>
                <span id="failed-evals" class="score score-bad">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Average Score</span>
                <span id="avg-score" class="score">-</span>
            </div>
        </div>

        <div id="results-table-container" class="main-form">
            <h2 style="margin-bottom: 1rem;">All Evaluations</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Student/File</th>
                        <th>Type</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </div>

        <div id="no-results" class="hidden" style="text-align: center; padding: 2rem; color: var(--gray-500);">
            <p>No evaluations yet. <a href="/">Start your first evaluation</a></p>
        </div>
    </div>
</div>

<style>
.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.history-header h1 {
    margin-bottom: 0;
}
.type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}
.type-pdf { background: #dbeafe; color: #1e40af; }
.type-image { background: #fef3c7; color: #92400e; }
.type-text { background: #d1fae5; color: #065f46; }
.action-btns {
    display: flex;
    gap: 0.5rem;
}
.btn-icon {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const loading = document.getElementById('loading');
    const historyContent = document.getElementById('history-content');
    const resultsTbody = document.getElementById('results-tbody');
    const noResults = document.getElementById('no-results');
    const exportAllBtn = document.getElementById('export-all-btn');
    let allReviews = [];

    try {
        const response = await fetch('/api/reviews/?limit=100');
        allReviews = await response.json();

        loading.classList.add('hidden');
        historyContent.classList.remove('hidden');

        if (allReviews.length === 0) {
            document.getElementById('results-table-container').classList.add('hidden');
            noResults.classList.remove('hidden');
            exportAllBtn.classList.add('hidden');
            return;
        }

        renderTable();

    } catch (err) {
        loading.innerHTML = `<p class="error">Error loading history: ${err.message}</p>`;
    }

    function renderTable() {
        resultsTbody.innerHTML = '';

        // Calculate stats
        const completed = allReviews.filter(r => r.status === 'completed');
        const failed = allReviews.filter(r => r.status === 'failed');
        const scores = completed.filter(r => r.total_score !== null).map(r => r.total_score);
        const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : null;

        document.getElementById('total-evals').textContent = allReviews.length;
        document.getElementById('completed-evals').textContent = completed.length;
        document.getElementById('failed-evals').textContent = failed.length;
        document.getElementById('avg-score').textContent = avgScore !== null ? avgScore.toFixed(1) + '%' : '-';
        document.getElementById('avg-score').className = `score ${avgScore >= 70 ? 'score-good' : avgScore >= 50 ? 'score-ok' : 'score-bad'}`;

        // Populate table
        allReviews.forEach((review, index) => {
            const row = document.createElement('tr');
            row.id = `review-row-${review.id}`;
            const date = new Date(review.created_at);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const fileName = review.original_filename || 'Text input';
            const scoreClass = review.total_score >= 70 ? 'score-good' : review.total_score >= 50 ? 'score-ok' : 'score-bad';
            const statusClass = review.status === 'completed' ? 'status-completed' : review.status === 'failed' ? 'status-failed' : 'status-processing';

            row.innerHTML = `
                <td>${allReviews.length - index}</td>
                <td>${dateStr}</td>
                <td title="${fileName}">${fileName.length > 30 ? fileName.substring(0, 30) + '...' : fileName}</td>
                <td><span class="type-badge type-${review.input_type}">${review.input_type}</span></td>
                <td class="score-cell ${scoreClass}">${review.total_score !== null ? review.total_score.toFixed(1) + '%' : '-'}</td>
                <td><span class="status ${statusClass}">${review.status}</span></td>
                <td class="action-btns">
                    <a href="/results/${review.id}" class="btn-link">View</a>
                    <button type="button" class="btn btn-danger btn-icon" onclick="deleteReview(${review.id})">Delete</button>
                </td>
            `;
            resultsTbody.appendChild(row);
        });
    }

    window.deleteReview = async (id) => {
        if (!confirm('Delete this evaluation? This cannot be undone.')) return;

        try {
            const res = await fetch(`/api/reviews/${id}`, { method: 'DELETE' });
            if (res.ok) {
                allReviews = allReviews.filter(r => r.id !== id);
                if (allReviews.length === 0) {
                    document.getElementById('results-table-container').classList.add('hidden');
                    noResults.classList.remove('hidden');
                    exportAllBtn.classList.add('hidden');
                } else {
                    renderTable();
                }
            } else {
                alert('Failed to delete');
            }
        } catch (err) {
            alert('Error deleting');
        }
    };

    exportAllBtn.addEventListener('click', () => {
        window.location.href = '/api/reviews/export/csv';
    });
});
</script>
{% endblock %}
