{% extends "base.html" %}

{% block title %}Evalaite - Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Dashboard</h1>
        <a href="/results" class="btn btn-secondary">View All Results</a>
    </div>

    <!-- Create Exam Section -->
    <div class="card">
        <h2>Create New Exam</h2>

        <div class="form-row">
            <div class="form-group">
                <label for="exam-series">Exam Series</label>
                <select id="exam-series" class="form-control">
                    <option value="">-- Select Series --</option>
                </select>
                <small class="form-hint">Manage series in <a href="/admin">Admin</a></small>
            </div>
            <div class="form-group">
                <label for="exam-form">Form</label>
                <select id="exam-form" class="form-control">
                    <option value="">-- Select Form --</option>
                    <option value="Form 1">Form 1</option>
                    <option value="Form 2">Form 2</option>
                    <option value="Form 3">Form 3</option>
                    <option value="Form 4">Form 4</option>
                </select>
            </div>
            <div class="form-group">
                <label for="exam-subject">Subject</label>
                <select id="exam-subject" class="form-control">
                    <option value="">-- Select Subject --</option>
                </select>
                <small class="form-hint">Manage subjects in <a href="/admin">Admin</a></small>
            </div>
        </div>

        <div class="form-group">
            <label for="preset-select">Evaluation Prompt</label>
            <select id="preset-select" class="form-control">
                <option value="">-- Select Saved Prompt --</option>
            </select>
            <textarea id="custom-prompt" class="form-control textarea-mono" placeholder="Enter evaluation criteria or select a saved prompt above..."></textarea>
            <div id="save-controls" class="inline-form hidden">
                <input type="text" id="save-prompt-name" placeholder="Prompt name..." class="form-control">
                <button type="button" class="btn btn-secondary" id="save-prompt-btn">Save Prompt</button>
            </div>
        </div>

        <div class="form-group">
            <label>Marking Scheme <span class="text-muted">(Optional)</span></label>
            <div class="form-row">
                <div class="form-group" style="flex: 0 0 200px;">
                    <div class="dropzone" id="scheme-dropzone">
                        <input type="file" id="scheme-input" accept=".pdf,.png,.jpg,.jpeg" hidden>
                        <div class="dropzone-content">
                            <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path d="M12 16V4m0 0L8 8m4-4l4 4M4 20h16"/>
                            </svg>
                            <span>Drop file or click</span>
                        </div>
                    </div>
                    <div id="scheme-preview" class="file-tag hidden">
                        <span id="scheme-name"></span>
                        <button type="button" class="file-tag-remove" id="remove-scheme">&times;</button>
                    </div>
                    <div id="scheme-loading" class="hidden" style="padding: 0.5rem; color: var(--gray-500);">
                        <span class="spinner-small"></span> Transcribing...
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <textarea id="scheme-transcription" class="form-control textarea-mono" rows="6" placeholder="Transcribed marking scheme will appear here after upload. You can edit it to correct any errors."></textarea>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Student Scripts</label>
                <div class="dropzone" id="scripts-dropzone">
                    <input type="file" id="scripts-input" accept=".pdf,.png,.jpg,.jpeg" multiple hidden>
                    <div class="dropzone-content">
                        <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M12 16V4m0 0L8 8m4-4l4 4M4 20h16"/>
                        </svg>
                        <span>Drop files or click (multiple)</span>
                    </div>
                </div>
                <div id="scripts-list" class="file-tags"></div>
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-lg" id="create-exam-btn">Create Exam & Evaluate</button>
    </div>

    <div id="loading" class="loading-box hidden">
        <div class="spinner"></div>
        <p id="progress-text">Processing...</p>
    </div>

    <div id="error" class="alert alert-error hidden"></div>

    <!-- Recent Exams -->
    <div class="card">
        <h2>Recent Exams</h2>
        <div id="exams-list"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    let subjects = [], series = [], exams = [], savedPrompts = [];
    let currentPresetPrompt = '';
    let scriptFiles = [];

    const examSeries = document.getElementById('exam-series');
    const examForm = document.getElementById('exam-form');
    const examSubject = document.getElementById('exam-subject');
    const presetSelect = document.getElementById('preset-select');
    const promptInput = document.getElementById('custom-prompt');
    const saveControls = document.getElementById('save-controls');
    const schemeInput = document.getElementById('scheme-input');
    const schemeDropzone = document.getElementById('scheme-dropzone');
    const schemePreview = document.getElementById('scheme-preview');
    const scriptsInput = document.getElementById('scripts-input');
    const scriptsDropzone = document.getElementById('scripts-dropzone');
    const scriptsListEl = document.getElementById('scripts-list');
    const createExamBtn = document.getElementById('create-exam-btn');
    const examsList = document.getElementById('exams-list');
    const loading = document.getElementById('loading');
    const progressText = document.getElementById('progress-text');
    const errorDiv = document.getElementById('error');

    await Promise.all([loadSubjects(), loadSeries(), loadExams(), loadPrompts()]);

    async function loadSubjects() {
        try {
            const res = await fetch('/api/subjects');
            if (!res.ok) throw new Error('Failed to load subjects');
            subjects = await res.json();
            examSubject.innerHTML = '<option value="">-- Select Subject --</option>' +
                subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        } catch (e) { console.error('loadSubjects error:', e); }
    }

    async function loadSeries() {
        try {
            const res = await fetch('/api/series');
            if (!res.ok) throw new Error('Failed to load series');
            series = await res.json();
            examSeries.innerHTML = '<option value="">-- Select Series --</option>' +
                series.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        } catch (e) { console.error('loadSeries error:', e); }
    }

    async function loadExams() {
        try {
            const res = await fetch('/api/exams');
            if (!res.ok) throw new Error('Failed to load exams');
            exams = await res.json();
            renderExams();
        } catch (e) { console.error('loadExams error:', e); }
    }

    async function loadPrompts() {
        try {
            const res = await fetch('/api/prompts/saved');
            if (!res.ok) throw new Error('Failed to load prompts');
            const data = await res.json();
            savedPrompts = data.prompts || [];
            presetSelect.innerHTML = '<option value="">-- Select Saved Prompt --</option>' +
                savedPrompts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        } catch (e) { console.error('loadPrompts error:', e); }
    }

    function renderExams() {
        if (exams.length === 0) {
            examsList.innerHTML = '<p class="empty-state">No exams yet. Create one above!</p>';
            return;
        }
        examsList.innerHTML = exams.slice(0, 10).map(e => `
            <div class="list-item">
                <div class="list-item-main">
                    <strong>${e.subject_name}</strong>
                    <span class="badge badge-secondary">${e.form}</span>
                    <span class="badge badge-primary">${e.series_name}</span>
                </div>
                <div class="list-item-meta">
                    <span>${e.script_count} scripts</span>
                    <span>${e.evaluated_count} evaluated</span>
                    ${e.average_score !== null ? `<span class="text-success">${e.average_score.toFixed(1)}%</span>` : ''}
                </div>
                <a href="/exam/${e.id}" class="btn btn-sm">View</a>
            </div>
        `).join('');
    }

    // Prompt handling
    presetSelect.addEventListener('change', () => {
        const name = presetSelect.value;
        if (!name) { promptInput.value = ''; currentPresetPrompt = ''; return; }
        const prompt = savedPrompts.find(p => p.name === name);
        if (prompt) { promptInput.value = prompt.prompt; currentPresetPrompt = prompt.prompt; }
        saveControls.classList.add('hidden');
    });

    promptInput.addEventListener('input', () => {
        const hasContent = promptInput.value.trim().length > 0;
        const isChanged = promptInput.value !== currentPresetPrompt;
        saveControls.classList.toggle('hidden', !(hasContent && isChanged));
    });

    document.getElementById('save-prompt-btn').addEventListener('click', async () => {
        const name = document.getElementById('save-prompt-name').value.trim();
        if (!name) { alert('Enter a name'); return; }
        await fetch('/api/prompts/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, prompt: promptInput.value })
        });
        currentPresetPrompt = promptInput.value;
        saveControls.classList.add('hidden');
        await loadPrompts();
        presetSelect.value = name;
    });

    // File handling
    function setupDropzone(dropzone, input, onFiles, multiple = false) {
        dropzone.addEventListener('click', () => input.click());
        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) onFiles(multiple ? Array.from(e.dataTransfer.files) : e.dataTransfer.files[0]);
        });
        input.addEventListener('change', () => {
            if (input.files.length) onFiles(multiple ? Array.from(input.files) : input.files[0]);
        });
    }

    const schemeTranscription = document.getElementById('scheme-transcription');
    const schemeLoading = document.getElementById('scheme-loading');
    let currentSchemeFile = null;

    setupDropzone(schemeDropzone, schemeInput, async (file) => {
        currentSchemeFile = file;
        document.getElementById('scheme-name').textContent = file.name;
        schemePreview.classList.remove('hidden');
        schemeDropzone.classList.add('hidden');
        schemeLoading.classList.remove('hidden');
        schemeTranscription.value = '';
        schemeTranscription.placeholder = 'Transcribing marking scheme...';

        // Upload and transcribe immediately
        try {
            const formData = new FormData();
            formData.append('file', file);

            // We need an exam ID to upload, so we'll create a temporary placeholder
            // Actually, we'll do the transcription client-side or defer until exam creation
            // For now, let's just show the file is selected and transcribe during exam creation
            // But the user wants immediate transcription, so we need a different approach

            // Let's add a dedicated transcription endpoint that doesn't require an exam
            const res = await fetch('/api/transcribe-marking-scheme', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                const data = await res.json();
                schemeTranscription.value = data.transcription;
            } else {
                schemeTranscription.value = 'Error transcribing. You can type the marking scheme manually.';
            }
        } catch (err) {
            schemeTranscription.value = 'Error transcribing. You can type the marking scheme manually.';
        } finally {
            schemeLoading.classList.add('hidden');
            schemeTranscription.placeholder = 'Transcribed marking scheme. You can edit it to correct any errors.';
        }
    });

    document.getElementById('remove-scheme').addEventListener('click', () => {
        schemeInput.value = '';
        currentSchemeFile = null;
        schemePreview.classList.add('hidden');
        schemeDropzone.classList.remove('hidden');
        schemeTranscription.value = '';
        schemeTranscription.placeholder = 'Transcribed marking scheme will appear here after upload. You can edit it to correct any errors.';
    });

    setupDropzone(scriptsDropzone, scriptsInput, (files) => {
        for (const file of files) {
            if (!scriptFiles.find(f => f.name === file.name)) scriptFiles.push(file);
        }
        renderScriptFiles();
    }, true);

    function renderScriptFiles() {
        scriptsListEl.innerHTML = scriptFiles.map((f, i) => `
            <div class="file-tag">
                <span>${f.name}</span>
                <button type="button" class="file-tag-remove" onclick="removeScript(${i})">&times;</button>
            </div>
        `).join('');
    }

    window.removeScript = (i) => { scriptFiles.splice(i, 1); renderScriptFiles(); };

    // Create exam
    createExamBtn.addEventListener('click', async () => {
        const seriesId = examSeries.value;
        const formValue = examForm.value;
        const subjectId = examSubject.value;

        if (!seriesId) { showError('Please select an exam series'); return; }
        if (!formValue) { showError('Please select a form'); return; }
        if (!subjectId) { showError('Please select a subject'); return; }
        if (scriptFiles.length === 0) { showError('Please upload at least one student script'); return; }

        loading.classList.remove('hidden');
        errorDiv.classList.add('hidden');

        try {
            progressText.textContent = 'Creating exam...';
            const examRes = await fetch('/api/exams', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    series_id: parseInt(seriesId),
                    form: formValue,
                    subject_id: parseInt(subjectId),
                    evaluation_prompt: promptInput.value.trim() || null
                })
            });
            if (!examRes.ok) throw new Error((await examRes.json()).detail || 'Failed to create exam');
            const exam = await examRes.json();

            // Upload marking scheme file and/or save transcription
            if (currentSchemeFile) {
                progressText.textContent = 'Uploading marking scheme...';
                const schemeFormData = new FormData();
                schemeFormData.append('file', currentSchemeFile);
                await fetch(`/api/exams/${exam.id}/marking-scheme`, { method: 'POST', body: schemeFormData });
            }
            // Save the (possibly edited) transcription
            const transcriptionText = schemeTranscription.value.trim();
            if (transcriptionText) {
                await fetch(`/api/exams/${exam.id}/marking-scheme-text`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: transcriptionText })
                });
            }

            progressText.textContent = 'Uploading student scripts...';
            const scriptsForm = new FormData();
            scriptFiles.forEach(f => scriptsForm.append('files', f));
            await fetch(`/api/exams/${exam.id}/scripts`, { method: 'POST', body: scriptsForm });

            progressText.textContent = 'Evaluating scripts with AI...';
            await fetch(`/api/exams/${exam.id}/evaluate`, { method: 'POST' });

            loading.classList.add('hidden');
            window.location.href = `/exam/${exam.id}`;
        } catch (err) {
            showError(err.message);
            loading.classList.add('hidden');
        }
    });

    function showError(msg) {
        errorDiv.textContent = msg;
        errorDiv.classList.remove('hidden');
    }
});
</script>
{% endblock %}
