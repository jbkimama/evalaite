{% extends "base.html" %}

{% block title %}All Results - Evalaite{% endblock %}

{% block content %}
<div class="container">
    <div class="results-header">
        <h1>All Exam Results</h1>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading results...</p>
    </div>

    <div id="results-content" class="hidden">
        <div id="summary-stats" class="summary-card" style="margin-bottom: 1.5rem;">
            <div class="summary-item">
                <span class="label">Total Exams</span>
                <span id="total-exams" class="score">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Total Scripts</span>
                <span id="total-scripts" class="score">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Evaluated</span>
                <span id="evaluated-scripts" class="score score-good">0</span>
            </div>
            <div class="summary-item">
                <span class="label">Average Score</span>
                <span id="avg-score" class="score">-</span>
            </div>
        </div>

        <div id="results-table-container" class="main-form">
            <h2 style="margin-bottom: 1rem;">Exams by Series</h2>
            <div id="exams-by-series"></div>
        </div>

        <div id="no-results" class="hidden" style="text-align: center; padding: 2rem; color: var(--gray-500);">
            <p>No exams yet. <a href="/">Create your first exam</a></p>
        </div>
    </div>
</div>

<style>
.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.results-header h1 {
    margin-bottom: 0;
}
.series-group {
    margin-bottom: 1.5rem;
}
.series-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--gray-100);
    border-radius: 0.5rem 0.5rem 0 0;
    border-bottom: 1px solid var(--gray-200);
}
.series-header h3 {
    margin: 0;
    font-size: 1rem;
}
.exam-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--gray-200);
}
.exam-row:last-child {
    border-bottom: none;
}
.exam-row:hover {
    background: var(--gray-50);
}
.exam-info {
    flex: 1;
}
.exam-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
}
.exam-meta {
    font-size: 0.85rem;
    color: var(--gray-500);
}
.exam-stats-inline {
    display: flex;
    gap: 1.5rem;
    align-items: center;
}
.exam-stats-inline span {
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const loading = document.getElementById('loading');
    const resultsContent = document.getElementById('results-content');
    const examsBySeries = document.getElementById('exams-by-series');
    const noResults = document.getElementById('no-results');

    try {
        const [examsRes, seriesRes] = await Promise.all([
            fetch('/api/exams'),
            fetch('/api/series')
        ]);
        const exams = await examsRes.json();
        const series = await seriesRes.json();

        loading.classList.add('hidden');
        resultsContent.classList.remove('hidden');

        if (exams.length === 0) {
            document.getElementById('results-table-container').classList.add('hidden');
            noResults.classList.remove('hidden');
            return;
        }

        // Calculate stats
        const totalScripts = exams.reduce((sum, e) => sum + e.script_count, 0);
        const totalEvaluated = exams.reduce((sum, e) => sum + e.evaluated_count, 0);
        const scoresSum = exams.reduce((sum, e) => sum + (e.average_score || 0) * e.evaluated_count, 0);
        const avgScore = totalEvaluated > 0 ? scoresSum / totalEvaluated : null;

        document.getElementById('total-exams').textContent = exams.length;
        document.getElementById('total-scripts').textContent = totalScripts;
        document.getElementById('evaluated-scripts').textContent = totalEvaluated;
        document.getElementById('avg-score').textContent = avgScore !== null ? avgScore.toFixed(1) + '%' : '-';
        if (avgScore !== null) {
            document.getElementById('avg-score').className = `score ${avgScore >= 70 ? 'score-good' : avgScore >= 50 ? 'score-ok' : 'score-bad'}`;
        }

        // Group exams by series
        const seriesMap = {};
        series.forEach(s => { seriesMap[s.id] = s.name; });

        const grouped = {};
        exams.forEach(e => {
            const seriesName = e.series_name || 'No Series';
            if (!grouped[seriesName]) grouped[seriesName] = [];
            grouped[seriesName].push(e);
        });

        // Render
        let html = '';
        for (const [seriesName, seriesExams] of Object.entries(grouped)) {
            html += `
                <div class="series-group">
                    <div class="series-header">
                        <h3>${seriesName}</h3>
                        <span>${seriesExams.length} exam(s)</span>
                    </div>
                    ${seriesExams.map(e => {
                        const scoreClass = e.average_score >= 70 ? 'score-good' : e.average_score >= 50 ? 'score-ok' : 'score-bad';
                        return `
                            <div class="exam-row">
                                <div class="exam-info">
                                    <h4>${e.subject_name}</h4>
                                    <span class="exam-meta">
                                        ${e.script_count} scripts, ${e.evaluated_count} evaluated
                                    </span>
                                </div>
                                <div class="exam-stats-inline">
                                    ${e.average_score !== null ? `<span class="score ${scoreClass}">${e.average_score.toFixed(1)}%</span>` : '<span>-</span>'}
                                    <a href="/exam/${e.id}" class="btn btn-small">View</a>
                                    <button class="btn btn-secondary btn-small" onclick="exportExam(${e.id})">CSV</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        examsBySeries.innerHTML = html;

    } catch (err) {
        loading.innerHTML = `<p class="error">Error loading results: ${err.message}</p>`;
    }

    window.exportExam = (examId) => {
        window.location.href = `/api/exams/${examId}/export/csv`;
    };
});
</script>
{% endblock %}
