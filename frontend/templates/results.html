{% extends "base.html" %}

{% block title %}Results - Evalaite{% endblock %}

{% block content %}
<div class="container">
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading results...</p>
    </div>

    <div id="results" class="hidden">
        <div class="results-header">
            <h1>Review Results</h1>
            <a href="/" class="btn btn-secondary">New Review</a>
        </div>

        <div class="summary-card" id="summary-card">
            <div class="summary-item">
                <span class="label">Status</span>
                <span id="status" class="status"></span>
            </div>
            <div class="summary-item">
                <span class="label">Overall Score</span>
                <span id="score" class="score"></span>
            </div>
            <div class="summary-item" id="correct-section">
                <span class="label">Correct Answers</span>
                <span id="correct"></span>
            </div>
            <div class="summary-item" id="total-section">
                <span class="label">Total Questions</span>
                <span id="total"></span>
            </div>
        </div>

        <div id="filename-display" class="hidden" style="margin-bottom: 1rem; color: #6b7280;">
            <strong>File:</strong> <span id="filename"></span>
        </div>

        <div id="error-message" class="error hidden"></div>

        <div id="questions-section">
            <h2>Evaluation Details</h2>
            <div id="questions-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const reviewId = {{ review_id }};
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');

    try {
        const response = await fetch(`/api/reviews/${reviewId}`);

        if (!response.ok) {
            throw new Error('Review not found');
        }

        const data = await response.json();
        displayResults(data);

    } catch (err) {
        loading.innerHTML = `<p class="error">Error: ${err.message}</p>`;
    }

    function displayResults(data) {
        loading.classList.add('hidden');
        results.classList.remove('hidden');

        // Check if this is a document evaluation
        const isDocumentEval = data.questions && data.questions.length === 1 &&
                               data.questions[0].question_text === 'Document Evaluation';

        // Show filename if available
        if (data.original_filename) {
            document.getElementById('filename').textContent = data.original_filename;
            document.getElementById('filename-display').classList.remove('hidden');
        }

        // Status
        const statusEl = document.getElementById('status');
        statusEl.textContent = data.status;
        statusEl.className = `status status-${data.status}`;

        // Score - show as percentage
        const scoreEl = document.getElementById('score');
        if (data.total_score !== null) {
            scoreEl.textContent = `${data.total_score.toFixed(1)}%`;
            scoreEl.className = `score ${data.total_score >= 70 ? 'score-good' : data.total_score >= 50 ? 'score-ok' : 'score-bad'}`;
        } else {
            scoreEl.textContent = 'N/A';
        }

        // Hide correct/total for document evaluations
        if (isDocumentEval) {
            document.getElementById('correct-section').style.display = 'none';
            document.getElementById('total-section').style.display = 'none';
        } else {
            document.getElementById('correct').textContent = data.correct_answers;
            document.getElementById('total').textContent = data.total_questions;
        }

        // Error message
        if (data.error_message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = data.error_message;
            errorEl.classList.remove('hidden');
        }

        // Questions/Evaluations
        const questionsList = document.getElementById('questions-list');

        if (data.questions && data.questions.length > 0) {
            // Check if this is a document evaluation (letter, essay, etc.)
            const isDocumentEval = data.questions.length === 1 && data.questions[0].question_text === 'Document Evaluation';

            if (isDocumentEval) {
                const q = data.questions[0];
                questionsList.innerHTML = `
                    <div class="question-card">
                        <div class="question-header">
                            <span class="question-number">Score: ${q.score?.toFixed(1) || 0}%</span>
                            <span class="question-result ${q.score >= 50 ? 'result-correct' : 'result-incorrect'}">
                                ${q.score >= 50 ? 'Pass' : 'Needs Improvement'}
                            </span>
                        </div>
                        <div class="question-body">
                            <div class="question-row">
                                <strong>Student's Work (Transcript):</strong>
                                <p style="white-space: pre-wrap; background: #f9fafb; padding: 1rem; border-radius: 0.5rem; font-family: inherit;">${escapeHtml(q.student_answer)}</p>
                            </div>
                            <div class="question-row feedback" style="margin-top: 1rem;">
                                <strong>Evaluation Report:</strong>
                                <p style="white-space: pre-wrap;">${escapeHtml(q.feedback || 'No feedback provided')}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                questionsList.innerHTML = data.questions.map(q => `
                    <div class="question-card ${q.is_correct ? 'correct' : 'incorrect'}">
                        <div class="question-header">
                            <span class="question-number">Question ${q.question_number}</span>
                            <span class="question-result ${q.is_correct ? 'result-correct' : 'result-incorrect'}">
                                ${q.is_correct ? 'Correct' : 'Incorrect'} - ${q.score?.toFixed(0) || 0}%
                            </span>
                        </div>
                        <div class="question-body">
                            <div class="question-row">
                                <strong>Question:</strong>
                                <p>${escapeHtml(q.question_text)}</p>
                            </div>
                            <div class="question-row">
                                <strong>Student Answer:</strong>
                                <p>${escapeHtml(q.student_answer)}</p>
                            </div>
                            ${q.correct_answer ? `
                            <div class="question-row">
                                <strong>Correct Answer:</strong>
                                <p>${escapeHtml(q.correct_answer)}</p>
                            </div>
                            ` : ''}
                            <div class="question-row feedback">
                                <strong>Feedback:</strong>
                                <p>${escapeHtml(q.feedback || 'No feedback provided')}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            questionsList.innerHTML = '<p class="no-questions">No evaluation results found.</p>';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}
